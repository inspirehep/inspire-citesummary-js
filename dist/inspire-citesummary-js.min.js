/*
 * This file is part of INSPIRE HEP.
 * Copyright (C) 2016 CERN.
 *
 * INSPIRE HEP is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License as
 * published by the Free Software Foundation; either version 2 of the
 * License, or (at your option) any later version.
 *
 * INSPIRE HEP is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with Invenio; if not, write to the Free Software Foundation, Inc.,
 * 59 Temple Place, Suite 330, Boston, MA 02111-1307, USA.
 *
 * In applying this license, CERN does not
 * waive the privileges and immunities granted to it by virtue of its status
 * as an Intergovernmental Organization or submit itself to any jurisdiction.
 */!function(t){t.module("citeSummary",["citeSummary.services","citeSummary.directives"])}(angular),function(t){function n(){function t(t,n){return n.template}var n=["$scope","CiteSummaryService",function(t,n){t.vm={},t.vm.loading=!0,t.vm.searchTerm=null,t.vm.showRelated=!1,n.load(t.apiEndpoint).then(function(n){t.vm.data=n,setTimeout(function(){citesummary_vis.render(t.vm.data)},0)})}];return{templateUrl:t,restrict:"AE",scope:{apiEndpoint:"@apiEndpoint"},controller:n}}t.module("citeSummary.directives",[]).directive("citeSummary",n)}(angular),function(t){t.module("citeSummary.services",[]).factory("CiteSummaryService",["$http",function(t){return{load:function(n){return t.get(n).then(function(t){return console.debug(t.data),t.data}).catch(function(t){return console.error("cannot fetch content from "+n,t),{}})}}}])}(angular);var citesummary_vis=function(){var t=d3.scale.ordinal().domain(["self","not self"]).range(["#3498db","#e74c3c"]),n=d3.scale.ordinal().range(["#95a5a6","#7f8c8d","#34495e","#8e44ad"]),e=d3.scale.ordinal().domain(["preprint","article"]).range(["#3498db","#2980b9"]),i="%d %b %Y",r=(d3.format(",d"),d3.time.format(i)),a=(d3.time.format("%I:%M %p"),d3.format("s"),function(t){return new Date(t.substring(0,4),t.substring(5,7),t.substring(8))}),o=function(t,n){return"string"==typeof t?(t=d3.time.format(i).parse(t),n=d3.time.format(i).parse(n),n-t):n.citation_date-t.citation_date},c=function(){return $(window).width()},u=function(t,n){return 900>=t?.63*t:t*n},d=function(t){var n=s(t);return console.log(n),n.forEach(function(t,n){t.index=n,t.paper_date=a(t.paper_date),t.citation_date=a(t.citation_date)}),n},s=function(t){var n=[];return t.forEach(function(t){var e={};Object.keys(t).forEach(function(n){"citations"!==n&&(e["paper_"+n]=t[n])}),t.citations.forEach(function(t){var i=$.extend({},e);Object.keys(t).forEach(function(n){"citations"!==n&&(i["citation_"+n]=t[n])}),n.push(i)})}),n};return{render:function(i){var a=d(i),s=crossfilter(a),l=s.dimension(function(t){return t.citation_date}),f=s.dimension(function(t){return t.citation_document_type}),m=s.dimension(function(t){return t.citation_selfcite?"self":"not self"}),p=s.dimension(function(t){return t.citation_subject}),g=l.group(),v=f.group(),_=m.group(),h=p.group(),b=0,y={all:function(){var t=0,n=[];return g.all().forEach(function(e){t+=e.value,b=t,n.push({key:e.key,value:t,single_value:e.value})}),n}},C=new Date(l.bottom(1)[0].citation_date),E=new Date(l.top(1)[0].citation_date),S=C,w=E;S.setDate(S.getDate()-30),w.setDate(w.getDate()+30);var D=c(),j=dc.compositeChart(document.getElementById("citations"));j.width(u(D,.85)).height(300).margins({top:10,right:50,bottom:30,left:60}).x(d3.time.scale().domain([S,w])).xUnits(d3.time.months).renderHorizontalGridLines(!0).dimension(l).renderVerticalGridLines(!0).compose([dc.lineChart(j).group(y,"Cumulative Citations").valueAccessor(function(t){return t.value}).colors(["#2980b9"]),dc.barChart(j).group(g,"Citations").colors(["#3498db"])]),j.legend(dc.legend().x(80).y(20).itemHeight(13).gap(5)).brushOn(!0),dc.pieChart("#citation_subjects").dimension(f).group(v).colors(e),dc.pieChart("#self_cites").dimension(m).group(_).colors(t),dc.pieChart("#subject_area").dimension(p).group(h).colors(n);var k=dc.dataTable("#data_table");k.dimension(l).group(function(t){return'<i class="fa fa-calendar"></i> '+r(t.citation_date)}).columns([function(){return""},function(t){return t.citation_id},function(t){return'<span class="label '+(t.citation_selfcite?"label-danger":"label-default")+'">'+(t.citation_selfcite?" Self Citation":"")+'</span> <a href="/record/'+t.citation_id+'" target="_blank">'+t.citation_title+"</a>"},function(t){return t.citation_document_type},function(t){return t.citation_subject},function(){}]).sortBy(function(t){return t.citation_date}).order(o),dc.renderAll()}}}();