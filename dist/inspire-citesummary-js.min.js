/*
 * This file is part of INSPIRE HEP.
 * Copyright (C) 2016 CERN.
 *
 * INSPIRE HEP is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License as
 * published by the Free Software Foundation; either version 2 of the
 * License, or (at your option) any later version.
 *
 * INSPIRE HEP is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with Invenio; if not, write to the Free Software Foundation, Inc.,
 * 59 Temple Place, Suite 330, Boston, MA 02111-1307, USA.
 *
 * In applying this license, CERN does not
 * waive the privileges and immunities granted to it by virtue of its status
 * as an Intergovernmental Organization or submit itself to any jurisdiction.
 */!function(t){t.module("citeSummary",["citeSummary.services","citeSummary.directives"])}(angular),function(t){function e(){function t(t,e){return e.template}var e=["$scope","CiteSummaryService",function(t,e){t.vm={},t.vm.loading=!0,t.vm.searchTerm=null,t.vm.showRelated=!1,e.load(t.apiEndpoint).then(function(e){t.vm.data=e,setTimeout(function(){citeSummaryVis.renderSummary(t.vm.data)},0)})}];return{templateUrl:t,restrict:"AE",scope:{apiEndpoint:"@apiEndpoint"},controller:e}}t.module("citeSummary.directives",[]).directive("citeSummary",e)}(angular),function(t){t.module("citeSummary.services",[]).factory("CiteSummaryService",["$http",function(t){return{load:function(e){return t.get(e).then(function(t){return t.data}).catch(function(t){return console.error("cannot fetch content from "+e,t),{}})}}}])}(angular);var citeSummaryVis=function(){var t=d3.scale.ordinal().domain(["self","not self"]).range(["#3498db","#e74c3c"]),e=d3.scale.ordinal().range(["#1abc9c","#27ae60","#3498db","#9b59b6","#34495e","#f39c12","#d35400","#c0392b","#95a5a6"]),n=d3.scale.ordinal().range(["#1abc9c","#27ae60","#3498db","#9b59b6","#34495e","#f39c12","#d35400","#c0392b","#95a5a6"]),i="%d %b %Y",a={"hep-th":"Theory-HEP","hep-ex":"Experiment-HEP","nucl-th":"Theory-Nucl","hep-ph":"Phenomenology-HEP","nucl-ex":"Experiment-Nucl","hep-lat":"Lattice"},r=(d3.format(",d"),d3.time.format(i)),o=(d3.time.format("%I:%M %p"),function(t){return new Date(t.substring(0,4),t.substring(5,7),t.substring(8))}),c=function(t,e){return"string"==typeof t?(t=d3.time.format(i).parse(t),e=d3.time.format(i).parse(e),e-t):e.citation_date-t.citation_date},u=function(){return $(window).width()},d=function(t,e){return 900>=t?.63*t:t*e},s=function(t){var e=l(t);return e.forEach(function(t,e){t.index=e,t.paper_date=o(t.paper_date),t.citation_date=o(t.citation_date),t.paper_subject in a&&(t.paper_subject=a[t.paper_subject]),t.citation_subject in a&&(t.citation_subject=a[t.citation_subject]),-1!=t.citation_subject.indexOf("astro")&&(t.citation_subject="Astrophysics")}),e},l=function(t){var e=[];return t.forEach(function(t){var n={};Object.keys(t).forEach(function(e){"citations"!==e&&(n["paper_"+e]=t[e])}),t.citations.forEach(function(t){var i=$.extend({},n);Object.keys(t).forEach(function(e){"citations"!==e&&(i["citation_"+e]=t[e])}),e.push(i)})}),e};return{renderSummary:function(i){var a=s(i),o=crossfilter(a),l=o.dimension(function(t){return t.citation_date}),m=o.dimension(function(t){return t.citation_document_type}),f=o.dimension(function(t){return t.citation_selfcite?"self":"not self"}),p=o.dimension(function(t){return t.citation_subject}),h=l.group(),b=m.group(),_=f.group(),g=p.group(),v={all:function(){var t=0,e=[];return h.all().forEach(function(n){t+=n.value,e.push({key:n.key,value:t,single_value:n.value})}),e}},y=new Date(l.bottom(1)[0].citation_date),E=new Date(l.top(1)[0].citation_date),S=y,j=E;S.setDate(S.getDate()-30),j.setDate(j.getDate()+30);var C=u(),w=o.groupAll();dc.dataCount(".dc-data-count").dimension(o).group(w);var x=dc.compositeChart(document.getElementById("citations"));x.width(d(C,.85)).height(300).margins({top:10,right:50,bottom:30,left:60}).x(d3.time.scale().domain([S,j])).xUnits(d3.time.months).renderHorizontalGridLines(!0).dimension(l).elasticY(!0).renderVerticalGridLines(!0).compose([dc.lineChart(x).group(v,"Cumulative Citations").valueAccessor(function(t){return t.value}).colors(["#2980b9"]),dc.barChart(x).group(h,"Citations").colors(["#3498db"])]),x.legend(dc.legend().x(80).y(20).itemHeight(13).gap(5)).brushOn(!0),dc.pieChart("#citation_subjects").width(350).dimension(m).group(b).colors(n),dc.pieChart("#self_cites").width(350).dimension(f).group(_).colors(t),dc.pieChart("#subject_area").width(350).dimension(p).group(g).colors(e);var D=dc.dataTable("#data_table");D.dimension(l).group(function(t){return'<i class="fa fa-calendar"></i> '+r(t.citation_date)}).columns([function(){return""},function(t){return t.citation_id},function(t){return'<span class="label '+(t.citation_selfcite?"label-danger":"label-default")+'">'+(t.citation_selfcite?" Self Citation":"")+'</span> <a href="/record/'+t.citation_id+'" target="_blank">'+t.citation_title+"</a>"},function(t){return t.citation_document_type},function(t){return t.citation_subject},function(){}]).sortBy(function(t){return t.citation_date}).order(c),dc.renderAll()}}}();