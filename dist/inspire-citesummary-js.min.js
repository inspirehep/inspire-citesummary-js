/*
 * This file is part of INSPIRE HEP.
 * Copyright (C) 2016 CERN.
 *
 * INSPIRE HEP is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License as
 * published by the Free Software Foundation; either version 2 of the
 * License, or (at your option) any later version.
 *
 * INSPIRE HEP is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with Invenio; if not, write to the Free Software Foundation, Inc.,
 * 59 Temple Place, Suite 330, Boston, MA 02111-1307, USA.
 *
 * In applying this license, CERN does not
 * waive the privileges and immunities granted to it by virtue of its status
 * as an Intergovernmental Organization or submit itself to any jurisdiction.
 */!function(t){t.module("citeSummary",["citeSummary.services","citeSummary.directives"])}(angular),function(t){function e(){function t(t,e){return e.template}var e=["$scope","CiteSummaryService",function(t,e){t.vm={},t.vm.loading=!0,t.vm.searchTerm=null,t.vm.showRelated=!1,e.load(t.apiEndpoint).then(function(e){t.vm.data=e,setTimeout(function(){citeSummaryVis.renderSummary(t.vm.data)},0)})}];return{templateUrl:t,restrict:"AE",scope:{apiEndpoint:"@apiEndpoint"},controller:e}}t.module("citeSummary.directives",[]).directive("citeSummary",e)}(angular),function(t){t.module("citeSummary.services",[]).factory("CiteSummaryService",["$http",function(t){return{load:function(e){return t.get(e).then(function(t){return t.data}).catch(function(t){return console.error("cannot fetch content from "+e,t),{}})}}}])}(angular);var citeSummaryVis=function(){var t=d3.scale.ordinal().domain(["self","not self"]).range(["#3498db","#e74c3c"]),e="%d %b %Y",n={"hep-th":"Theory-HEP","hep-ex":"Experiment-HEP","nucl-th":"Theory-Nucl","hep-ph":"Phenomenology-HEP","nucl-ex":"Experiment-Nucl","hep-lat":"Lattice","gr-qc":"General Relativity","quant-ph":"Quantum Physics","Nuclear Reactions":"General Physics","double-beta decay":"General Physics",astro:"Astrophysics",math:"Math and Math Physics",cs:"Computing",stat:"Data Analysis and Statistics",cond:"Other",nlin:"Other",Relativistic:"Experiment-HEP"},i=(d3.format(",d"),d3.time.format(e),d3.time.format("%I:%M %p"),d3.format("s")),a=function(t){return new Date(t.substring(0,4),t.substring(5,7),t.substring(8))},r=function(t,n){return"string"==typeof t?(t=d3.time.format(e).parse(t),n=d3.time.format(e).parse(n),n-t):n.citation_date-t.citation_date},o=function(){return $(window).width()},c=function(t,e){return 900>=t?.63*t:t*e},u=function(t,e,n,a){var r=dc.rowChart(t).dimension(e).height(500).width(300).group(n).colors(a);r.xAxis().ticks(5),r.xAxis().tickFormat(i)},s=function(t,e,n,i){dc.pieChart(t).dimension(e).width(250).group(n).colors(i)},d=function(t){var e=l(t);return e.forEach(function(t,e){t.index=e,t.paper_date=a(t.paper_date),t.citation_date=a(t.citation_date),["paper","citation"].forEach(function(e){var i=t[e+"_subject"];t[e+"_subject"]in n?t[e+"_subject"]=n[i]:Object.keys(n).forEach(function(a){return-1!=i.indexOf(a)?(t[e+"_subject"]=n[a],void 0):void 0})})}),e},l=function(t){var e=[];return t.forEach(function(t){var n={};Object.keys(t).forEach(function(e){"citations"!==e&&(n["paper_"+e]=t[e])}),t.citations.forEach(function(t){var i=$.extend({},n);Object.keys(t).forEach(function(e){"citations"!==e&&(i["citation_"+e]=t[e])}),e.push(i)})}),e};return{renderSummary:function(e){var n=!1;e.length>1&&(n=!0);var i=d(e),a=crossfilter(i),l=a.dimension(function(t){return t.citation_date}),m=a.dimension(function(t){return d3.time.year(t.citation_date)}),p=a.dimension(function(t){return t.citation_document_type}),f=a.dimension(function(t){return t.citation_selfcite?"self":"not self"}),h=a.dimension(function(t){return t.citation_collaboration?"Collaboration Paper":"Not a Collaboration Paper"}),g=a.dimension(function(t){return t.citation_subject}),_=a.dimension(function(t){return t.paper_date}),y=a.dimension(function(t){return d3.time.year(t.paper_date)}),v=a.dimension(function(t){return t.paper_document_type}),b=a.dimension(function(t){return t.paper_subject}),C=(a.dimension(function(t){return t.paper_collaboration?"Collaboration Paper":"Not a Collaboration Paper"}),_.group(),y.group()),x=v.group(),E=b.group(),w=(l.group(),m.group()),S=p.group(),P=f.group(),D=g.group(),j=h.group(),k={all:function(){var t=0,e=[];return w.all().forEach(function(n){t+=n.value,e.push({key:n.key,value:t,single_value:n.value})}),e}},A={all:function(){var t=0,e=[];return C.all().forEach(function(n){t+=n.value,e.push({key:n.key,value:t,single_value:n.value})}),e}},H=o(),O=a.groupAll();dc.dataCount("#citations_summary").dimension(a).group(O);var G={top:10,right:30,bottom:30,left:50};if(n){var L=new Date(_.bottom(1)[0].paper_date),N=new Date(_.top(1)[0].paper_date);L.setDate(L.getDate()-30),N.setDate(N.getDate()+30);var T=["#95a5a6"];dc.barChart("#papers_year").height(200).margins(G).width(c(H,n?.42:.85)).x(d3.time.scale().domain([d3.time.year(L),d3.time.year(N)])).xUnits(d3.time.years).dimension(y).group(C).colors(T);var U=dc.compositeChart(document.getElementById("papers"));U.width(c(H,n?.42:.85)).height(200).margins(G).x(d3.time.scale().domain([L,N])).xUnits(d3.time.months).renderHorizontalGridLines(!0).dimension(y).elasticY(!0).elasticX(!0).renderVerticalGridLines(!0).compose([dc.lineChart(U).group(A,"Cumulative Papers").valueAccessor(function(t){return t.value}).colors(T),dc.barChart(U).group(C,"Papers").colors(T)]),U.legend(dc.legend().x(80).y(20).itemHeight(13).gap(5)).brushOn(!0),u("#papers_document_type",v,x,T),u("#papers_subject_area",b,E,T)}var R=dc.compositeChart(document.getElementById("citations")),V=new Date(l.bottom(1)[0].citation_date),$=new Date(l.top(1)[0].citation_date);V.setDate(V.getDate()-30),$.setDate($.getDate()+30);var B=["#3498db"];dc.barChart("#citations_year").height(200).margins(G).width(c(H,n?.42:.85)).x(d3.time.scale().domain([d3.time.year(V),d3.time.year($)])).xUnits(d3.time.years).dimension(m).group(w).colors(B),R.width(c(H,n?.42:.85)).height(200).margins(G).x(d3.time.scale().domain([V,$])).xUnits(d3.time.months).renderHorizontalGridLines(!0).dimension(m).elasticY(!0).elasticX(!0).renderVerticalGridLines(!0).compose([dc.lineChart(R).group(k,"Cumulative Citations").valueAccessor(function(t){return t.value}).colors(B),dc.barChart(R).group(w,"Citations").colors(B)]),R.legend(dc.legend().x(80).y(20).itemHeight(13).gap(5)).brushOn(!0),u("#citations_subjects",p,S,B),u("#citations_subject_area",g,D,B),s("#citations_self_cites",f,P,t),s("#citations_collaboration",h,j,t);var I=dc.dataTable("#citations_data_table");I.dimension(l).group(function(t){return t.paper_id+" - "+t.paper_title}).columns([function(){return""},function(t){return t.citation_id},function(t){return'<span class="label '+(t.citation_selfcite?"label-danger":"label-default")+'">'+(t.citation_selfcite?" Self Citation":"")+'</span> <a href="/record/'+t.citation_id+'" target="_blank">'+t.citation_title+"</a>"},function(t){return t.citation_document_type},function(t){return t.citation_subject},function(){}]).sortBy(function(t){return t.citation_date}).order(r),dc.renderAll()}}}();